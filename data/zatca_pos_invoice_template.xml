<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>
        <!-- Simple ZATCA Simplified Invoice Template for POS Orders -->
        <template id="zatca_pos_simplified_invoice">
            <Invoice xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                     xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                     xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                     xmlns:ext="urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2">
                
                <!-- UBL Extensions for ZATCA (required but can be minimal for simplified) -->
                <ext:UBLExtensions>
                    <ext:UBLExtension>
                        <ext:ExtensionURI>urn:oasis:names:specification:ubl:dsig:enveloped:xades</ext:ExtensionURI>
                        <ext:ExtensionContent>
                            <!-- Minimal signature placeholder for simplified invoices -->
                            <sig:UBLDocumentSignatures xmlns:sig="urn:oasis:names:specification:ubl:schema:xsd:CommonSignatureComponents-2"
                                                       xmlns:sac="urn:oasis:names:specification:ubl:schema:xsd:SignatureAggregateComponents-2"
                                                       xmlns:sbc="urn:oasis:names:specification:ubl:schema:xsd:SignatureBasicComponents-2">
                                <sac:SignatureInformation>
                                    <cbc:ID>urn:oasis:names:specification:ubl:signature:1</cbc:ID>
                                    <sbc:ReferencedSignatureID>urn:oasis:names:specification:ubl:signature:Invoice</sbc:ReferencedSignatureID>
                                </sac:SignatureInformation>
                            </sig:UBLDocumentSignatures>
                        </ext:ExtensionContent>
                    </ext:UBLExtension>
                </ext:UBLExtensions>

                <!-- UBL Version and Customization -->
                <cbc:UBLVersionID>2.1</cbc:UBLVersionID>
                <cbc:CustomizationID>urn:cef.eu:en16931:2017#compliant#urn:xoev-de:kosit:standard:xrechnung_2.0</cbc:CustomizationID>
                <cbc:ProfileID>reporting:1.0</cbc:ProfileID>
                
                <!-- Invoice Identification -->
                <cbc:ID t-esc="invoice_data['invoice_number']"/>
                <cbc:UUID t-esc="invoice_data['uuid']"/>
                <cbc:IssueDate t-esc="invoice_data['issue_date']"/>
                <cbc:IssueTime t-esc="invoice_data['issue_time']"/>
                
                <!-- Invoice Type Code for simplified invoices -->
                <cbc:InvoiceTypeCode name="0200000">388</cbc:InvoiceTypeCode>
                
                <!-- Currency -->
                <cbc:DocumentCurrencyCode t-esc="invoice_data['currency_code']"/>
                <cbc:TaxCurrencyCode t-esc="invoice_data['currency_code']"/>
                
                <!-- ZATCA Required Additional Document References -->
                <!-- QR Code (BR-KSA-27) - Note: Will be populated by ZATCA API -->
                <cac:AdditionalDocumentReference>
                    <cbc:ID>QR</cbc:ID>
                    <cac:Attachment>
                        <cbc:EmbeddedDocumentBinaryObject mimeCode="text/plain" t-esc="invoice_data.get('qr_code', 'placeholder')"/>
                    </cac:Attachment>
                </cac:AdditionalDocumentReference>
                
                <!-- Previous Invoice Hash (PIH) - BR-KSA-61 -->
                <cac:AdditionalDocumentReference>
                    <cbc:ID>PIH</cbc:ID>
                    <cac:Attachment>
                        <cbc:EmbeddedDocumentBinaryObject mimeCode="text/plain" t-esc="invoice_data.get('previous_invoice_hash', 'NWZlY2ViNjZmZmM4NmYzOGQ5NTI3ODZjNmQ2OTZjNzljMmRiYzIzOWRkNGU5MWI0NjcyOWQ3M2EyN2ZiNTdlOQ==')"/>
                    </cac:Attachment>
                </cac:AdditionalDocumentReference>
                
                <!-- Invoice Counter Value (ICV) - BR-KSA-33 -->
                <cac:AdditionalDocumentReference>
                    <cbc:ID>ICV</cbc:ID>
                    <cbc:UUID t-esc="invoice_data.get('invoice_counter', '1')"/>
                </cac:AdditionalDocumentReference>
                
                <!-- Signature references (BR-KSA-29 and BR-KSA-30) -->
                <cac:Signature>
                    <cbc:ID>urn:oasis:names:specification:ubl:signature:Invoice</cbc:ID>
                    <cbc:SignatureMethod>urn:oasis:names:specification:ubl:dsig:enveloped:xades</cbc:SignatureMethod>
                </cac:Signature>

                <!-- Supplier Party (Company) -->
                <cac:AccountingSupplierParty>
                    <cac:Party>
                        <cac:PartyIdentification>
                            <cbc:ID schemeID="CRN" t-esc="invoice_data['supplier']['commercial_registration']"/>
                        </cac:PartyIdentification>
                        <cac:PostalAddress>
                            <cbc:StreetName t-esc="invoice_data['supplier']['street']"/>
                            <cbc:BuildingNumber t-esc="invoice_data['supplier']['building_number']"/>
                            <cbc:PlotIdentification t-esc="invoice_data['supplier']['additional_number']"/>
                            <cbc:CitySubdivisionName t-esc="invoice_data['supplier']['district']"/>
                            <cbc:CityName t-esc="invoice_data['supplier']['city']"/>
                            <cbc:PostalZone t-esc="invoice_data['supplier']['zip']"/>
                            <cbc:CountrySubentity t-esc="invoice_data['supplier']['state']"/>
                            <cac:Country>
                                <cbc:IdentificationCode t-esc="invoice_data['supplier']['country_code']"/>
                            </cac:Country>
                        </cac:PostalAddress>
                        <cac:PartyTaxScheme>
                            <cbc:CompanyID t-esc="invoice_data['supplier']['vat']"/>
                            <cac:TaxScheme>
                                <cbc:ID>VAT</cbc:ID>
                            </cac:TaxScheme>
                        </cac:PartyTaxScheme>
                        <cac:PartyLegalEntity>
                            <cbc:RegistrationName t-esc="invoice_data['supplier']['name']"/>
                        </cac:PartyLegalEntity>
                    </cac:Party>
                </cac:AccountingSupplierParty>

                <!-- Customer Party (simplified for B2C) -->
                <cac:AccountingCustomerParty>
                    <cac:Party>
                        <cac:PartyLegalEntity>
                            <cbc:RegistrationName t-esc="invoice_data['customer']['name']"/>
                        </cac:PartyLegalEntity>
                    </cac:Party>
                </cac:AccountingCustomerParty>

                <!-- Tax Total for entire invoice (BR-KSA-EN16931-09: only one tax total without subtotals) -->
                <cac:TaxTotal>
                    <cbc:TaxAmount currencyID="SAR" t-esc="'%.2f' % invoice_data['total_tax']"/>
                </cac:TaxTotal>
                
                <!-- Additional Tax Total with subtotals for SAR currency -->
                <cac:TaxTotal>
                    <cbc:TaxAmount currencyID="SAR" t-esc="'%.2f' % invoice_data['total_tax']"/>
                    <cac:TaxSubtotal>
                        <cbc:TaxableAmount currencyID="SAR" t-esc="'%.2f' % invoice_data['total_without_tax']"/>
                        <cbc:TaxAmount currencyID="SAR" t-esc="'%.2f' % invoice_data['total_tax']"/>
                        <cac:TaxCategory>
                            <cbc:ID>S</cbc:ID>
                            <cbc:Percent t-esc="'%.2f' % 15.0"/>
                            <cac:TaxScheme>
                                <cbc:ID>VAT</cbc:ID>
                            </cac:TaxScheme>
                        </cac:TaxCategory>
                    </cac:TaxSubtotal>
                </cac:TaxTotal>

                <!-- Legal Monetary Total -->
                <cac:LegalMonetaryTotal>
                    <cbc:LineExtensionAmount currencyID="SAR" t-esc="'%.2f' % invoice_data['total_without_tax']"/>
                    <cbc:TaxExclusiveAmount currencyID="SAR" t-esc="'%.2f' % invoice_data['total_without_tax']"/>
                    <cbc:TaxInclusiveAmount currencyID="SAR" t-esc="'%.2f' % invoice_data['total_with_tax']"/>
                    <cbc:PayableAmount currencyID="SAR" t-esc="'%.2f' % invoice_data['total_with_tax']"/>
                </cac:LegalMonetaryTotal>

                <!-- Invoice Lines (must come after LegalMonetaryTotal) -->
                <t t-foreach="invoice_data['lines']" t-as="line">
                    <cac:InvoiceLine>
                        <cbc:ID t-esc="line['line_number']"/>
                        <cbc:InvoicedQuantity unitCode="PCE" t-esc="'%.6f' % line['quantity']"/>
                        <cbc:LineExtensionAmount currencyID="SAR" t-esc="'%.2f' % line['line_total_without_tax']"/>
                        
                        <!-- Item -->
                        <cac:Item>
                            <cbc:Name t-esc="line['product_name']"/>
                            <cac:ClassifiedTaxCategory>
                                <cbc:ID>S</cbc:ID>
                                <cbc:Percent t-esc="'%.2f' % line['tax_rate']"/>
                                <cac:TaxScheme>
                                    <cbc:ID>VAT</cbc:ID>
                                </cac:TaxScheme>
                            </cac:ClassifiedTaxCategory>
                        </cac:Item>
                        
                        <!-- Price (BR-KSA-EN16931-11 compliance) -->
                        <!-- Line Extension Amount = Invoiced Quantity * (Price Amount / Base Quantity) -->
                        <cac:Price>
                            <cbc:PriceAmount currencyID="SAR" t-esc="'%.6f' % line['unit_price']"/>
                            <cbc:BaseQuantity unitCode="PCE" t-esc="'%.6f' % line['base_quantity']"/>
                        </cac:Price>
                    </cac:InvoiceLine>
                </t>
            </Invoice>
        </template>
    </data>
</odoo>
